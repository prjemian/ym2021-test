name: Cacheing Something

on: push

jobs:
  cache-job:
    name: Cache EPICS Docker Images
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Cache vault directory
      id: cache-vault
      uses: actions/cache@v3
      with:
        path: ~/vault
        key: ${{ runner.os }}-epics_docker-v1_1-DEBUG

    - name: Generate Cache Content
      if: steps.cache-vault.outputs.cache-hit != 'true'
      run: |
        mkdir -p ~/vault
        wget $URL/$REPO/$AD/start_adsim.sh
        wget $URL/$REPO/$SYNAPPS/start_xxx.sh
        wget $URL/$REPO/$SYNAPPS/remove_container.sh
        mv start_adsim.sh remove_container.sh  start_xxx.sh   ~/vault
        # get the images
        docker pull prjemian/custom-synapps-6.2:latest
        docker pull prjemian/custom-synapps-6.2-ad-3.10:latest
        sudo (cd /var/lib && tar cf - docker | (cd ~/vault && tar xf -))
      env:
        AD: v1.1/n6_custom_areaDetector
        SYNAPPS: v1.1/n5_custom_synApps
        REPO: prjemian/epics-docker/main
        URL: https://raw.githubusercontent.com

    - name: Show Cache Content
      run: |
        ls -lAFgh ~/vault/
        cat ~/vault/start_xxx.sh
        sudo ls /var/lib/docker

  use-cache:
    name: Use Cache
    runs-on: ubuntu-latest
    needs: cache-job

    steps:
    - uses: actions/checkout@v3

    - name: Epics Docker Image Cache
      id: cache-vault
      uses: actions/cache@v3
      with:
        path: ~/vault
        key: ${{ runner.os }}-epics_docker-v1_1

    - name: Show Cache Content
      run: |
        ls -lAFgh ~/vault
        cat ~/vault/start_xxx.sh
